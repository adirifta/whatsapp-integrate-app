name: Deploy Backend to cPanel

on:
  push:
    branches: [ main, master ]
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-be.yml'
  workflow_dispatch:

env:
  NODE_VERSION: '18'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: backend/package-lock.json

    - name: Install dependencies
      run: |
        cd backend
        npm ci --production

    - name: Create production environment file
      run: |
        cd backend
        cat > .env << EOF
        NODE_ENV=production
        PORT=${{ secrets.BE_PORT }}
        DB_HOST=${{ secrets.DB_HOST }}
        DB_USER=${{ secrets.DB_USER }}
        DB_PASSWORD=${{ secrets.DB_PASSWORD }}
        DB_NAME=${{ secrets.DB_NAME }}
        JWT_SECRET=${{ secrets.JWT_SECRET }}
        EOF

    - name: Create cPanel configuration files
      run: |
        # Create .htaccess for Apache
        cat > backend/.htaccess << 'EOF'
        RewriteEngine On
        
        # Redirect to HTTPS
        RewriteCond %{HTTPS} off
        RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
        
        # Proxy to Node.js application
        RewriteRule ^$ http://127.0.0.1:${{ secrets.BE_PORT }}/ [P,L]
        RewriteRule ^(.*)$ http://127.0.0.1:${{ secrets.BE_PORT }}/$1 [P,L]
        EOF
        
        # Create package.json for cPanel
        cat > backend/package.json << EOF
        {
          "name": "whatsapp-backend",
          "version": "1.0.0",
          "type": "module",
          "scripts": {
            "start": "node server.js",
            "dev": "node server.js"
          },
          "dependencies": {
            "express": "^4.18.2",
            "mysql2": "^3.6.0",
            "cors": "^2.8.5",
            "bcryptjs": "^2.4.3",
            "jsonwebtoken": "^9.0.2",
            "whatsapp-web.js": "^1.23.0",
            "qrcode-terminal": "^0.12.0",
            "dotenv": "^16.3.1"
          }
        }
        EOF

    - name: Setup FTP Deploy
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./backend/
        server-dir: ./public_html/be.yourdomain.com/
        dangerous-clean-slate: false
        exclude: |
          **/.git*
          **/.git*/**
          **/node_modules/**
          **/tests/**
          **/coverage/**
          **/.env.example
          **/README.md
          **/jest.config.js
          **/nodemon.json

    - name: Execute remote setup script
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          cd ~/public_html/be.yourdomain.com
          npm install --production
          pm2 restart whatsapp-backend || pm2 start server.js --name whatsapp-backend

    - name: Send success notification
      if: success()
      run: |
        echo "✅ Backend deployed successfully to be.yourdomain.com"
        
    - name: Send failure notification
      if: failure()
      run: |
        echo "❌ Backend deployment failed"